{"version":3,"sources":["webpack:///./invoices.search.js"],"names":[],"mappings":";;;;;;AAAA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,iBAAiB,MAAM;AACvB;AACA;AACA,yBAAyB;;AAEzB;AACA;AACA;AACA,SAAS;AACT;;AAEA;AACA;AACA;AACA,iBAAiB,MAAM;AACvB;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,iBAAiB,OAAO;AACxB,iBAAiB,OAAO;AACxB,iBAAiB,SAAS;AAC1B;AACA,mBAAmB;AACnB;AACA;AACA;AACA;AACA;AACA,SAAS;;AAET;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;;AAEX;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;;AAEb;AACA,aAAa;AACb;;AAEA,wFAAwF,oBAAoB;AAC5G;;AAEA;AACA;AACA,WAAW;AACX;;AAEA;AACA;AACA;AACA,2BAA2B,oBAAoB;AAC/C;AACA;AACA,iBAAiB;AACjB;AACA;;AAEA;AACA;AACA,aAAa;AACb,WAAW;AACX,SAAS;AACT;;AAEA;AACA;AACA;AACA,iBAAiB,OAAO;AACxB;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,iBAAiB,OAAO;AACxB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,yBAAyB,wBAAwB;AACjD;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC","file":"invoices.search.js","sourcesContent":["'use strict';\n\nvar app  = require('./app'),\n    main = require('./main')(app);\n\n(function(app) {\n  \n  /**\n   * push the code into the app startup stack\n   */\n  app.startup.push(function() {\n\n      /**\n       * register all required elements\n       *\n       * searchInput:            the search input field\n       * searchSubmit:           the search submit button\n       * advancedSearchControls: the container for the advanced search control inputs\n       * searchResultsContainer: the container for search results\n       * searchResultList:       the list with search results\n       */\n      app.elements.searchInput = document.getElementById('search-input');\n      app.elements.searchSubmit                 = document.getElementById('submit-search');\n      app.elements.advancedSearchControls       = document.getElementById('advanced-search-controls');\n      app.elements.advancedSearchControlsToggle = document.getElementsByClassName('advanced-search-controls-toggle')[ 0 ];\n      app.elements.searchResultsContainer       = document.getElementsByClassName('search-results')[ 0 ];\n      app.elements.searchResultList             = app.elements.searchResultsContainer.getElementsByTagName('ul') [ 0 ];\n\n      /**\n       * Adds all invoice search page event listener to their targets\n       */\n      app.listeners.addInvoiceSearchEvents = function() {\n        app.elements.advancedSearchControlsToggle.addEventListener('click', app.events.toggleAdvancedSearchControls);\n        app.elements.searchInput.addEventListener('keydown', app.events.checkInputKeypress);\n        app.elements.searchSubmit.addEventListener('click', app.events.submitSearch);\n      };\n\n      app.events.checkInputKeypress = function(event) {\n        if (event.keyCode === 13) {\n          event.preventDefault();\n          app.elements.searchSubmit.click();\n        }\n      };\n\n      /**\n       * toggles search request submission\n       *\n       * @param {Event} event\n       */\n      app.events.submitSearch = function(event) {\n        var options = {}; // TODO: Parse advanced search options\n\n        event.target.classList.add('search-in-progress');\n        app.connectors.searchInvoice(app.elements.searchInput.value, options, function() {\n          event.target.classList.remove('search-in-progress');\n        });\n      };\n\n      /**\n       * toggles the display of the advanced search controls\n       *\n       * @param {Event} event\n       */\n      app.events.toggleAdvancedSearchControls = function(event) {\n        event.preventDefault();\n        event.target.classList.toggle('control-active');\n        app.elements.advancedSearchControls.classList.toggle('active');\n      };\n\n      /**\n       * emits a socket.io search request\n       *\n       * @param {string} query       the search query\n       * @param {object} options     search options to use for the request\n       * @param {function} callback  a callback to execute once the search request has been\n       *   processed\n       * @returns {*}\n       */\n      app.connectors.searchInvoice = function(query, options, callback) {\n        console.log('starting search for %s', query);\n        app.io.emit('invoices.search', {\n          query: query\n        }, function(error, data) {\n\n          /**\n           * push the search results page into history\n           */\n          history.pushState({\n            query:   query,\n            options: options\n          }, 'Suchergebnisse für ' + query, '/invoices/search/' + query);\n\n          if (error) {\n            console.error(error);\n\n            return callback();\n          }\n\n          var results = data.results;\n\n          /**\n           * remove all child nodes\n           */\n          try {\n            app.elements.searchResultsContainer.getElementsByTagName('h2')[ 0 ].remove();\n            app.elements.searchResultList.remove();\n          }\n          catch (elementMissingError) {\n          }\n\n          /**\n           * if there are no results, just append the banner\n           */\n          if (results.length === 0) {\n            app.templates.noSearchResults(query).then(function(element) {\n              app.elements.searchResultsContainer.appendChild(element);\n            }).then(function() {\n\n              return callback();\n            });\n          }\n\n          app.elements.searchResultsContainer.appendChild(app.helpers.createNode('ul', { class: 'invoices' }));\n          app.elements.searchResultList = app.elements.searchResultsContainer.getElementsByTagName('ul') [ 0 ];\n\n          app.templates.nSearchResults(results.length, query).then(function(element) {\n            app.elements.searchResultsContainer.insertBefore(element, app.elements.searchResultsContainer.firstChild);\n          }).then(function() {\n            var resultPromises = [];\n\n            /**\n             * iterate over search results, append the result template for each\n             */\n            for (var i = 0; i < results.length; i++) {\n              resultPromises.push(app.templates.searchResult(results[ i ]).then(function(element) {\n                  app.elements.searchResultList.appendChild(element);\n                })\n              );\n            }\n\n            return Promise.all(resultPromises).then(function() {\n              return callback();\n            });\n          });\n        });\n      };\n\n      /**\n       * template for the \"no results\" banner\n       *\n       * @param {string} query  the original search query\n       */\n      app.templates.noSearchResults = function(query) {\n        return app.helpers.createTranslatedElement('<h2 class=\"no-results\">[[search:no_results, ' + query + ']]</h2>');\n      };\n\n      app.templates.nSearchResults = function(resultCount, query) {\n        if (resultCount === 1) {\n          return app.helpers.createTranslatedElement('<h2>[[search:single_result, ' + query + ']]</h2>');\n        }\n\n        return app.helpers.createTranslatedElement('<h2>[[search:multiple_results, ' + resultCount + ', ' + query + ']]</h2>');\n      };\n\n      /**\n       * template for a single search result entry\n       *\n       * @param {object} result            an object containing all result data\n       */\n      app.templates.searchResult = function(result) {\n        var template = '<li class=\"search-result invoice' + (result.ownInvoice ? ' own-invoice' : '') + '\" id=\"' + result._id + '\">' +\n          '<section class=\"invoice-image\">' +\n          '<img src=\"/images/invoices/' + result.user._id + '/' + result._id + '.jpg\" alt=\"Rechnung ' + result._id + '\" onerror=\"app.events.imageError(this)\">' +\n          '</section>' +\n          '<section class=\"invoice-data\">' +\n          '<div class=\"invoice-id\">' + result._id + '</div>' +\n          '<div class=\"invoice-owner\" id=\"' + result.user._id + '\">' +\n          '<div class=\"profile-picture\">' +\n          '<img src=\"/images/users/' + result.user._id + '.jpg\" alt>' +\n          '</div>' +\n          '<span class=\"owner-name\">' + result.user.firstName + ' ' + result.user.lastName + '</span>' +\n          '</div>' +\n          '[[invoices:date]]: <span class=\"invoice-creation-date\">' + result.creationDate + '</span><br>' +\n          '[[invoices:sum]]:' + (result.sum ? '<span class=\"invoice-sum\">' + result.sum + '</span>€' : '[[invoices:no_sum]]') +\n          '<br>' +\n          '<div class=\"tags-label\">[[invoices:tags]]:</div>' +\n          '<div class=\"invoice-tags\">';\n\n        if (result.tags.length) {\n          for (var i = 0; i < result.tags.length; i++) {\n            template += '<div class=\"tag tag-' + result.tags[ i ].color + '\" id=\"' + result.tags[ i ]._id + '\">' +\n              '<span>' + result.tags[ i ].name + '</span>' +\n              '</div>';\n          }\n        } else {\n          template += '<span class=\"no-tags\">[[invoices:no_tags]]</span>';\n        }\n\n        template += '</div>' +\n          '</section>' +\n          '<section class=\"invoice-actions\" data-own=\"' + result.ownInvoice + '\">' +\n          '<a class=\"button\" href=\"/invoices/' + result._id + '\"><span class=\"fa fa-eye\"></span> [[global:details]]</a>';\n\n        if (result.ownInvoice) {\n          template += '<a class=\"button\" href=\"/invoices/' + result._id + '/edit\"><span class=\"fa fa-edit\"></span> [[global:edit]]</a>' +\n            '<a class=\"button danger\" href=\"/invoices/' + result._id + '/delete\"><span class=\"fa fa-trash-o\"></span> [[global:delete]]</a>';\n        }\n\n        template += '</section></li>';\n\n        return app.helpers.createTranslatedElement(template);\n      };\n\n      /**\n       * Attach all event listeners for the invoice search page\n       */\n      app.listeners.addInvoiceSearchEvents();\n    }\n  );\n})(app);\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./invoices.search.js\n// module id = 235\n// module chunks = 7"],"sourceRoot":""}